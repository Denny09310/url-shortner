@page "/"

@inject ApiClient Api
@inject ToastService Toast

<AnimatedBackground />

<div class="flex min-h-screen w-full justify-center px-4 py-6 sm:items-center">

    <section class="flex w-full max-w-2xl flex-col gap-4 sm:gap-6">

        <!-- Top actions -->
        <div class="flex w-full justify-end">
            <LumexLink Href="management" Underline="Underline.Hover">
                Manage links
            </LumexLink>
        </div>

        <!-- Search -->
        <LumexTextbox @bind-Value="_search" @bind-Value:after="LoadAsync"
                      Size="Size.Large"
                      Behavior="InputBehavior.OnInput"
                      DebounceDelay="500"
                      Placeholder="Search an URL"
                      Clearable>
            <StartContent>
                <SearchIcon class="size-5" />
            </StartContent>
        </LumexTextbox>

        <!-- Results -->
        <LumexCard FullWidth class="flex min-h-[50vh] flex-col sm:min-h-0">

            <LumexCardHeader>
                <h1 class="text-lg font-medium">
                    Latest added
                </h1>
            </LumexCardHeader>

            <LumexCardBody class="max-h-[60vh] flex-1 overflow-y-auto sm:max-h-96">

                @if (_loading)
                {
                    <LinkSkeletonLoader />
                }
                else if (_links?.Count == 0)
                {
                    <div class="text-default-500 flex size-full items-center justify-center text-sm">
                        No links saved yet.
                    </div>
                }
                else
                {
                    <div class="space-y-2">
                        @foreach (var link in _links!)
                        {
                            <LinkItem @key="link.Id" Link="@link" />
                        }
                    </div>
                }

            </LumexCardBody>
        </LumexCard>

    </section>

</div>


@code
{
    private IReadOnlyList<LinkDto>? _links;
    private bool _loading;
    private string? _search;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _loading = true;

            var response = await Api.Links
                .GetAsync(new GetLinksRequest(_search));

            if (!response.IsSuccess)
            {
                Toast.Error("Can't retrieve URLs data.");
                return;
            }

            _links = response.Value;
        }
        finally
        {
            _loading = false;
        }
    }
}