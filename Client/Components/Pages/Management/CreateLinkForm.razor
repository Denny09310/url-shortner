@using System.ComponentModel.DataAnnotations

@inject ManagementState State
@inject ToastService Toast

<EditForm EditContext="@_context" OnValidSubmit="CreateLinkAsync">
    <DataAnnotationsValidator />

    <div class="mb-12 space-y-2">
        <LumexTextbox @bind-Value="Input.ShortCode"
                      Label="Short code"
                      Description="Used in the shortened URL (e.g. /my-link)"
                      LabelPlacement="LabelPlacement.Outside">
            <StartContent>
                <span class="mb-1 text-lg">/</span>
            </StartContent>
        </LumexTextbox>
        <ValidationMessage For="@(() => Input.ShortCode)" class="text-danger-500 text-xs" />
    </div>

    <div class="space-y-2">
        <LumexTextbox @bind-Value="Input.TargetUrl"
                      Label="Target URL"
                      Placeholder="https://example.com"
                      LabelPlacement="LabelPlacement.Outside">
            <StartContent>
                <LinkIcon class="size-4" />
            </StartContent>
        </LumexTextbox>
        <ValidationMessage For="@(() => Input.TargetUrl)" class="text-danger-500 text-xs" />
    </div>

    <div class="flex flex-col gap-2 pt-4 md:flex-row md:items-center md:justify-end">

        <LumexButton Variant="Variant.Flat"
                     Disabled="_submitting"
                     OnClick="CancelAsync">
            Cancel
        </LumexButton>

        <LumexButton Color="ThemeColor.Primary"
                     Disabled="_submitting || !_context.Validate()"
                     Type="ButtonType.Submit">
            @(_submitting ? "Creating link" : "Create link")
        </LumexButton>

    </div>
</EditForm>

@code
{
    [CascadingParameter] private BottomSheetInstance Instance { get; set; } = default!;

    private EditContext _context = default!;
    private bool _submitting;

    private InputModel Input { get; set; } = new();

    protected override void OnInitialized()
    {
        _context = new EditContext(Input);
    }

    private async Task CreateLinkAsync()
    {
        if (_submitting)
            return;

        _submitting = true;

        var result = await State.CreateAsync(
            Input.ShortCode.Trim(),
            Input.TargetUrl.Trim());

        _submitting = false;

        if (result == StateResult.Failure)
        {
            Toast.Error("Failed to create link.");
            return;
        }

        Toast.Success("Link created.");
        await Instance.CloseAsync();
    }

    private async Task CancelAsync()
    {
        await Instance.CloseAsync();
    }

    private sealed class InputModel
    {
        [Required, MinLength(2)]
        public string ShortCode { get; set; } = "";

        [Required, Url]
        public string TargetUrl { get; set; } = "";
    }
}